<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Marcador de Voleibol</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary-color: #3498db;
            --secondary-color: #e74c3c;
            --dark-color: #2c3e50;
            --light-color: #ecf0f1;
            --success-color: #2ecc71;
            --warning-color: #f39c12;
            --shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            --transition: all 0.3s ease;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background: linear-gradient(135deg, #1a2a6c, #b21f1f, #fdbb2d);
            color: var(--light-color);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Cabecera reorganizada */
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding: 20px;
            background-color: rgba(44, 62, 80, 0.9);
            border-radius: 15px;
            box-shadow: var(--shadow);
            flex-wrap: wrap;
        }

        .header-left {
            flex: 1;
            min-width: 200px;
        }

        h1 {
            font-size: 2.2rem;
            margin-bottom: 5px;
            color: white;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }

        .subtitle {
            font-size: 1rem;
            opacity: 0.9;
        }

        .clock-container {
            background-color: rgba(52, 152, 219, 0.8);
            padding: 12px 20px;
            border-radius: 10px;
            text-align: center;
            box-shadow: var(--shadow);
            min-width: 150px;
        }

        #clock {
            font-size: 1.4rem;
            font-weight: bold;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3);
        }

        .scoreboard {
            display: flex;
            justify-content: space-between;
            margin-bottom: 30px;
            gap: 20px;
        }

        .team {
            flex: 1;
            background-color: rgba(44, 62, 80, 0.9);
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            box-shadow: var(--shadow);
            transition: var(--transition);
            position: relative;
        }

        .team:hover {
            transform: translateY(-5px);
        }

        .team-name {
            font-size: 1.5rem;
            margin-bottom: 15px;
            font-weight: bold;
            cursor: pointer;
            padding: 5px;
            border-radius: 5px;
            transition: var(--transition);
        }

        .team-name:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }

        .score {
            font-size: 4rem;
            font-weight: bold;
            margin: 20px 0;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }

        .score-controls {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 20px;
        }

        .btn {
            padding: 10px 15px;
            border: none;
            border-radius: 8px;
            font-size: 1.1rem;
            font-weight: bold;
            cursor: pointer;
            transition: var(--transition);
            box-shadow: var(--shadow);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-primary {
            background-color: var(--primary-color);
            color: white;
        }

        .btn-secondary {
            background-color: var(--secondary-color);
            color: white;
        }

        .btn-success {
            background-color: var(--success-color);
            color: white;
        }

        .btn-warning {
            background-color: var(--warning-color);
            color: white;
        }

        .btn-info {
            background-color: #17a2b8;
            color: white;
        }

        .btn:hover {
            transform: scale(1.05);
            opacity: 0.9;
        }

        .sets {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 20px;
        }

        .set {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background-color: rgba(255, 255, 255, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }

        .set.won {
            background-color: var(--success-color);
        }

        .match-controls {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 15px;
            margin: 30px 0;
        }

        .current-set {
            text-align: center;
            margin-bottom: 10px;
            font-size: 1.2rem;
            background-color: rgba(255, 255, 255, 0.1);
            padding: 10px;
            border-radius: 8px;
        }

        .history {
            background-color: rgba(44, 62, 80, 0.9);
            border-radius: 15px;
            padding: 20px;
            box-shadow: var(--shadow);
            margin-bottom: 20px;
        }

        .history h2 {
            text-align: center;
            margin-bottom: 20px;
            font-size: 1.8rem;
        }

        .history-list {
            max-height: 300px;
            overflow-y: auto;
            margin-bottom: 20px;
        }

        .history-item {
            background-color: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .history-teams {
            flex: 1;
        }

        .history-score {
            font-weight: bold;
            font-size: 1.2rem;
            margin: 0 15px;
        }

        .history-date {
            font-size: 0.9rem;
            opacity: 0.7;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .modal-content {
            background-color: var(--dark-color);
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 500px;
            box-shadow: var(--shadow);
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal h2 {
            margin-bottom: 20px;
            text-align: center;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
        }

        .form-group input, .form-group textarea {
            width: 100%;
            padding: 12px;
            border-radius: 8px;
            border: none;
            background-color: rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 1rem;
        }

        .form-group textarea {
            min-height: 120px;
            resize: vertical;
        }

        .modal-buttons {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 20px;
        }

        .empty-history {
            text-align: center;
            padding: 20px;
            opacity: 0.7;
        }

        .export-controls {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 20px;
        }

        .share-preview {
            background-color: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
            text-align: center;
        }

        .share-preview h3 {
            margin-bottom: 15px;
        }

        #share-text {
            background-color: rgba(0, 0, 0, 0.2);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            text-align: left;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 200px;
            overflow-y: auto;
        }

        @media (max-width: 768px) {
            header {
                flex-direction: column;
                text-align: center;
                gap: 15px;
            }
            
            .header-left {
                width: 100%;
            }
            
            .scoreboard {
                flex-direction: column;
            }
            
            .score {
                font-size: 3rem;
            }
            
            h1 {
                font-size: 1.8rem;
            }
            
            .btn {
                padding: 8px 12px;
                font-size: 1rem;
            }
            
            .match-controls {
                gap: 10px;
            }
        }

        @media (max-width: 480px) {
            .container {
                padding: 10px;
            }
            
            .match-controls, .export-controls {
                flex-direction: column;
            }
            
            .btn {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="header-left">
                <h1><i class="fas fa-volleyball-ball"></i> Marcador de Voleibol</h1>
                <p class="subtitle">Lleva el control de tus partidos de voleibol</p>
            </div>
            <div class="clock-container">
                <div id="clock">00:00:00</div>
                <div id="date">--/--/----</div>
            </div>
        </header>

        <div class="current-set">
            <strong>Set Actual:</strong> <span id="current-set">1</span> de 5 | 
            <strong>Puntos para ganar:</strong> <span id="target-score">25</span> (con diferencia de 2)
        </div>

        <div class="scoreboard">
            <div class="team" id="team1">
                <div class="team-name" id="team1-name">Equipo Local</div>
                <div class="score" id="team1-score">0</div>
                <div class="sets" id="team1-sets">
                    <!-- Los sets se generar치n din치micamente -->
                </div>
                <div class="score-controls">
                    <button class="btn btn-primary" id="team1-add">
                        <i class="fas fa-plus"></i> Punto
                    </button>
                    <button class="btn btn-secondary" id="team1-remove">
                        <i class="fas fa-minus"></i> Punto
                    </button>
                </div>
            </div>

            <div class="team" id="team2">
                <div class="team-name" id="team2-name">Equipo Visitante</div>
                <div class="score" id="team2-score">0</div>
                <div class="sets" id="team2-sets">
                    <!-- Los sets se generar치n din치micamente -->
                </div>
                <div class="score-controls">
                    <button class="btn btn-primary" id="team2-add">
                        <i class="fas fa-plus"></i> Punto
                    </button>
                    <button class="btn btn-secondary" id="team2-remove">
                        <i class="fas fa-minus"></i> Punto
                    </button>
                </div>
            </div>
        </div>

        <div class="match-controls">
            <button class="btn btn-success" id="new-set">
                <i class="fas fa-flag"></i> Nuevo Set
            </button>
            <button class="btn btn-warning" id="reset-match">
                <i class="fas fa-redo"></i> Reiniciar Partido
            </button>
            <button class="btn btn-primary" id="save-match">
                <i class="fas fa-save"></i> Guardar Partido
            </button>
        </div>

        <div class="export-controls">
            <button class="btn btn-info" id="export-csv">
                <i class="fas fa-file-csv"></i> Exportar a CSV
            </button>
            <button class="btn btn-success" id="share-whatsapp">
                <i class="fab fa-whatsapp"></i> Compartir
            </button>
            <button class="btn btn-primary" id="share-results">
                <i class="fas fa-share-alt"></i> Compartir Texto
            </button>
        </div>

        <div class="history">
            <h2><i class="fas fa-history"></i> Historial de Partidos</h2>
            <div class="history-list" id="history-list">
                <!-- Los partidos guardados se mostrar치n aqu칤 -->
            </div>
            <div class="match-controls">
                <button class="btn btn-secondary" id="clear-history">
                    <i class="fas fa-trash"></i> Borrar Historial
                </button>
            </div>
        </div>
    </div>

    <!-- Modal para editar nombres de equipos -->
    <div class="modal" id="team-name-modal">
        <div class="modal-content">
            <h2>Editar Nombre del Equipo</h2>
            <div class="form-group">
                <label for="team-name-input">Nombre del equipo:</label>
                <input type="text" id="team-name-input" placeholder="Ingresa el nombre del equipo">
            </div>
            <div class="modal-buttons">
                <button class="btn btn-secondary" id="cancel-edit">Cancelar</button>
                <button class="btn btn-primary" id="save-name">Guardar</button>
            </div>
        </div>
    </div>

    <!-- Modal para compartir resultados -->
    <div class="modal" id="share-modal">
        <div class="modal-content">
            <h2>Compartir Resultados</h2>
            <div class="share-preview">
                <h3>Vista previa del resultado:</h3>
                <div id="share-text">
                    <!-- Texto generado din치micamente -->
                </div>
                <div class="modal-buttons">
                    <button class="btn btn-secondary" id="copy-text">
                        <i class="fas fa-copy"></i> Copiar Texto
                    </button>
                    <button class="btn btn-success" id="share-native">
                        <i class="fas fa-share"></i> Compartir
                    </button>
                    <button class="btn btn-secondary" id="close-share">Cerrar</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Variables globales
        let currentMatch = {
            team1: {
                name: "Equipo Local",
                score: 0,
                sets: 0
            },
            team2: {
                name: "Equipo Visitante",
                score: 0,
                sets: 0
            },
            currentSet: 1,
            maxSets: 5,
            startTime: new Date(),
            setHistory: []
        };

        let matchHistory = [];
        let editingTeam = null;
        let setWonInProgress = false; // Para evitar m칰ltiples alertas

        // Elementos DOM
        const team1NameEl = document.getElementById('team1-name');
        const team1ScoreEl = document.getElementById('team1-score');
        const team1SetsEl = document.getElementById('team1-sets');
        const team1AddBtn = document.getElementById('team1-add');
        const team1RemoveBtn = document.getElementById('team1-remove');

        const team2NameEl = document.getElementById('team2-name');
        const team2ScoreEl = document.getElementById('team2-score');
        const team2SetsEl = document.getElementById('team2-sets');
        const team2AddBtn = document.getElementById('team2-add');
        const team2RemoveBtn = document.getElementById('team2-remove');

        const newSetBtn = document.getElementById('new-set');
        const resetMatchBtn = document.getElementById('reset-match');
        const saveMatchBtn = document.getElementById('save-match');
        const clearHistoryBtn = document.getElementById('clear-history');
        const exportCsvBtn = document.getElementById('export-csv');
        const shareWhatsappBtn = document.getElementById('share-whatsapp');
        const shareResultsBtn = document.getElementById('share-results');

        const historyListEl = document.getElementById('history-list');
        const clockEl = document.getElementById('clock');
        const dateEl = document.getElementById('date');
        const currentSetEl = document.getElementById('current-set');
        const targetScoreEl = document.getElementById('target-score');

        const teamNameModal = document.getElementById('team-name-modal');
        const teamNameInput = document.getElementById('team-name-input');
        const cancelEditBtn = document.getElementById('cancel-edit');
        const saveNameBtn = document.getElementById('save-name');

        const shareModal = document.getElementById('share-modal');
        const shareTextEl = document.getElementById('share-text');
        const copyTextBtn = document.getElementById('copy-text');
        const shareNativeBtn = document.getElementById('share-native');
        const closeShareBtn = document.getElementById('close-share');

        // Funci칩n para obtener el puntaje objetivo seg칰n el set actual
        function getTargetScore() {
            // Los primeros 4 sets son a 25, el quinto set es a 15
            return currentMatch.currentSet <= 4 ? 25 : 15;
        }

        // Funci칩n para actualizar el reloj
        function updateClock() {
            const now = new Date();
            const timeString = now.toLocaleTimeString();
            const dateString = now.toLocaleDateString();
            
            clockEl.textContent = timeString;
            dateEl.textContent = dateString;
        }

        // Funci칩n para verificar si se ha ganado el set
        function checkSetWin() {
            const targetScore = getTargetScore();
            const score1 = currentMatch.team1.score;
            const score2 = currentMatch.team2.score;
            
            // Verificar si alg칰n equipo alcanz칩 el puntaje objetivo con diferencia de 2
            if (score1 >= targetScore && score1 - score2 >= 2) {
                // Equipo 1 gana el set
                currentMatch.team1.sets++;
                
                // Guardar resultado del set
                currentMatch.setHistory.push({
                    set: currentMatch.currentSet,
                    team1: score1,
                    team2: score2,
                    winner: currentMatch.team1.name
                });
                
                // Mostrar alerta de set ganado
                setTimeout(() => {
                    alert(`${currentMatch.team1.name} gana el set ${currentMatch.currentSet} por ${score1}-${score2}`);
                }, 100);
                
                // Verificar si se gan칩 el partido
                checkMatchWin();
                return true;
            }
            
            if (score2 >= targetScore && score2 - score1 >= 2) {
                // Equipo 2 gana el set
                currentMatch.team2.sets++;
                
                // Guardar resultado del set
                currentMatch.setHistory.push({
                    set: currentMatch.currentSet,
                    team1: score1,
                    team2: score2,
                    winner: currentMatch.team2.name
                });
                
                // Mostrar alerta de set ganado
                setTimeout(() => {
                    alert(`${currentMatch.team2.name} gana el set ${currentMatch.currentSet} por ${score2}-${score1}`);
                }, 100);
                
                // Verificar si se gan칩 el partido
                checkMatchWin();
                return true;
            }
            
            return false;
        }

        // Funci칩n para verificar si se ha ganado el partido
        function checkMatchWin() {
            const setsToWin = Math.ceil(currentMatch.maxSets / 2); // 3 de 5 sets
            
            if (currentMatch.team1.sets >= setsToWin || currentMatch.team2.sets >= setsToWin) {
                // Determinar ganador
                let winner;
                
                if (currentMatch.team1.sets > currentMatch.team2.sets) {
                    winner = currentMatch.team1.name;
                } else {
                    winner = currentMatch.team2.name;
                }
                
                // Mostrar mensaje de victoria despu칠s de un peque침o delay
                setTimeout(() => {
                    alert(`춰${winner} ha ganado el partido! \n\nResultado final: ${currentMatch.team1.sets} - ${currentMatch.team2.sets}\n\nSe guardar치 autom치ticamente en el historial.`);
                    
                    // Guardar el partido autom치ticamente
                    saveCurrentMatch();
                    
                    // Reiniciar para nuevo partido
                    resetCurrentMatch();
                }, 500);
                
                return true;
            } else {
                // Pasar al siguiente set
                setTimeout(() => {
                    startNewSet();
                }, 800);
                return false;
            }
        }

        // Inicializaci칩n
        document.addEventListener('DOMContentLoaded', function() {
            // Iniciar reloj
            updateClock();
            setInterval(updateClock, 1000);
            
            // Cargar datos guardados
            loadFromCookies();
            renderCurrentMatch();
            renderMatchHistory();
            
            // Event listeners para los botones de puntuaci칩n
            team1AddBtn.addEventListener('click', () => updateScore('team1', 1));
            team1RemoveBtn.addEventListener('click', () => updateScore('team1', -1));
            team2AddBtn.addEventListener('click', () => updateScore('team2', 1));
            team2RemoveBtn.addEventListener('click', () => updateScore('team2', -1));
            
            // Event listeners para los nombres de equipos (edici칩n)
            team1NameEl.addEventListener('click', () => openTeamNameModal('team1'));
            team2NameEl.addEventListener('click', () => openTeamNameModal('team2'));
            
            // Event listeners para los controles del partido
            newSetBtn.addEventListener('click', () => {
                if (currentMatch.team1.score > 0 || currentMatch.team2.score > 0) {
                    if (confirm("Hay puntos en juego. 쮽orzar fin del set actual y comenzar nuevo set?")) {
                        startNewSet();
                    }
                } else {
                    startNewSet();
                }
            });
            
            resetMatchBtn.addEventListener('click', resetCurrentMatch);
            saveMatchBtn.addEventListener('click', saveCurrentMatch);
            clearHistoryBtn.addEventListener('click', clearMatchHistory);
            
            // Event listeners para exportaci칩n y compartir
            exportCsvBtn.addEventListener('click', exportToCsv);
            shareWhatsappBtn.addEventListener('click', shareToWhatsapp);
            shareResultsBtn.addEventListener('click', openShareModal);
            
            // Event listeners para el modal de edici칩n de nombres
            cancelEditBtn.addEventListener('click', closeTeamNameModal);
            saveNameBtn.addEventListener('click', saveTeamName);
            
            // Event listeners para el modal de compartir
            copyTextBtn.addEventListener('click', copyShareText);
            shareNativeBtn.addEventListener('click', shareViaNative);
            closeShareBtn.addEventListener('click', closeShareModal);
        });

        // Funciones principales
        function updateScore(team, change) {
            // Si ya se est치 procesando un set ganado, no hacer nada
            if (setWonInProgress) return;
            
            // Aplicar el cambio
            currentMatch[team].score += change;
            
            // Asegurarse de que el marcador no sea negativo
            if (currentMatch[team].score < 0) {
                currentMatch[team].score = 0;
            }
            
            // Verificar si se gan칩 el set despu칠s de actualizar el puntaje
            const setWon = checkSetWin();
            
            // Si no se gan칩 el set, renderizar normalmente
            if (!setWon) {
                renderCurrentMatch();
                saveToCookies();
            } else {
                // Marcar que se est치 procesando un set ganado
                setWonInProgress = true;
                
                // Actualizar la pantalla
                renderCurrentMatch();
                saveToCookies();
                
                // Restablecer despu칠s de un breve tiempo
                setTimeout(() => {
                    setWonInProgress = false;
                }, 1000);
            }
        }

        function startNewSet() {
            // Incrementar el set actual
            currentMatch.currentSet++;
            
            // Reiniciar los marcadores de puntos
            currentMatch.team1.score = 0;
            currentMatch.team2.score = 0;
            
            // Renderizar
            renderCurrentMatch();
            saveToCookies();
        }

        function resetCurrentMatch() {
            if (confirm("쮼st치s seguro de que quieres reiniciar el partido? Se perder치 el progreso actual.")) {
                currentMatch.team1.score = 0;
                currentMatch.team2.score = 0;
                currentMatch.team1.sets = 0;
                currentMatch.team2.sets = 0;
                currentMatch.currentSet = 1;
                currentMatch.startTime = new Date();
                currentMatch.setHistory = [];
                renderCurrentMatch();
                saveToCookies();
            }
        }

        function saveCurrentMatch() {
            // Solo guardar si hay al menos un set ganado
            if (currentMatch.team1.sets === 0 && currentMatch.team2.sets === 0) {
                alert("No se puede guardar un partido sin sets ganados.");
                return;
            }
            
            const now = new Date();
            const matchData = {
                team1: {...currentMatch.team1},
                team2: {...currentMatch.team2},
                currentSet: currentMatch.currentSet,
                setHistory: [...currentMatch.setHistory],
                date: now.toLocaleString(),
                timestamp: now.getTime(),
                duration: Math.round((now - currentMatch.startTime) / 1000 / 60) // Duraci칩n en minutos
            };
            
            matchHistory.unshift(matchData);
            
            // Mantener solo los 칰ltimos 10 partidos para no sobrecargar las cookies
            if (matchHistory.length > 10) {
                matchHistory = matchHistory.slice(0, 10);
            }
            
            renderMatchHistory();
            saveToCookies();
            
            alert("Partido guardado correctamente en el historial.");
        }

        function clearMatchHistory() {
            if (confirm("쮼st치s seguro de que quieres borrar todo el historial de partidos?")) {
                matchHistory = [];
                renderMatchHistory();
                saveToCookies();
            }
        }

        function openTeamNameModal(team) {
            editingTeam = team;
            teamNameInput.value = currentMatch[team].name;
            teamNameModal.style.display = 'flex';
        }

        function closeTeamNameModal() {
            teamNameModal.style.display = 'none';
            editingTeam = null;
        }

        function saveTeamName() {
            if (editingTeam && teamNameInput.value.trim() !== '') {
                currentMatch[editingTeam].name = teamNameInput.value.trim();
                renderCurrentMatch();
                saveToCookies();
            }
            closeTeamNameModal();
        }

        // Funciones de renderizado
        function renderCurrentMatch() {
            // Actualizar nombres
            team1NameEl.textContent = currentMatch.team1.name;
            team2NameEl.textContent = currentMatch.team2.name;
            
            // Actualizar puntuaciones
            team1ScoreEl.textContent = currentMatch.team1.score;
            team2ScoreEl.textContent = currentMatch.team2.score;
            
            // Actualizar sets
            renderSets(team1SetsEl, currentMatch.team1.sets);
            renderSets(team2SetsEl, currentMatch.team2.sets);
            
            // Actualizar informaci칩n del set actual
            currentSetEl.textContent = currentMatch.currentSet;
            targetScoreEl.textContent = getTargetScore();
        }

        function renderSets(container, setsWon) {
            container.innerHTML = '';
            for (let i = 0; i < currentMatch.maxSets; i++) {
                const setEl = document.createElement('div');
                setEl.className = 'set';
                if (i < setsWon) {
                    setEl.classList.add('won');
                }
                setEl.textContent = i + 1;
                container.appendChild(setEl);
            }
        }

        function renderMatchHistory() {
            historyListEl.innerHTML = '';
            
            if (matchHistory.length === 0) {
                const emptyMessage = document.createElement('div');
                emptyMessage.className = 'empty-history';
                emptyMessage.innerHTML = '<i class="fas fa-clipboard-list fa-2x"></i><p>No hay partidos guardados. 춰Juega y guarda algunos partidos!</p>';
                historyListEl.appendChild(emptyMessage);
                return;
            }
            
            matchHistory.forEach((match, index) => {
                const historyItem = document.createElement('div');
                historyItem.className = 'history-item';
                
                const teamsDiv = document.createElement('div');
                teamsDiv.className = 'history-teams';
                teamsDiv.textContent = `${match.team1.name} vs ${match.team2.name}`;
                
                const scoreDiv = document.createElement('div');
                scoreDiv.className = 'history-score';
                scoreDiv.textContent = `${match.team1.sets}-${match.team2.sets}`;
                
                const dateDiv = document.createElement('div');
                dateDiv.className = 'history-date';
                dateDiv.textContent = match.date;
                
                historyItem.appendChild(teamsDiv);
                historyItem.appendChild(scoreDiv);
                historyItem.appendChild(dateDiv);
                
                historyListEl.appendChild(historyItem);
            });
        }

        // Funciones de exportaci칩n
        function exportToCsv() {
            if (matchHistory.length === 0) {
                alert("No hay datos para exportar. Guarda algunos partidos primero.");
                return;
            }
            
            // Encabezados CSV
            let csv = "Fecha,Hora,Equipo 1,Sets Equipo 1,Equipo 2,Sets Equipo 2,Ganador,Duraci칩n (min)\n";
            
            // Datos de cada partido
            matchHistory.forEach(match => {
                const date = new Date(match.timestamp);
                const fecha = date.toLocaleDateString();
                const hora = date.toLocaleTimeString();
                const ganador = match.team1.sets > match.team2.sets ? match.team1.name : match.team2.name;
                const duracion = match.duration || 0;
                
                csv += `"${fecha}","${hora}","${match.team1.name}",${match.team1.sets},"${match.team2.name}",${match.team2.sets},"${ganador}",${duracion}\n`;
            });
            
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = `marcador_voleibol_${new Date().toISOString().slice(0, 10)}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            alert("Datos exportados a CSV correctamente. Puedes abrir el archivo en Excel.");
        }

        // Funciones para compartir
        function generateShareText() {
            const now = new Date();
            const dateStr = now.toLocaleDateString();
            const timeStr = now.toLocaleTimeString();
            
            let text = `游끯 MARCADOR DE VOLEIBOL 游끯\n`;
            text += `游늰 ${dateStr} 游 ${timeStr}\n\n`;
            text += `=== PARTIDO ACTUAL ===\n`;
            text += `${currentMatch.team1.name}: ${currentMatch.team1.score} puntos\n`;
            text += `${currentMatch.team2.name}: ${currentMatch.team2.score} puntos\n\n`;
            text += `Sets ganados:\n`;
            text += `${currentMatch.team1.name}: ${currentMatch.team1.sets}\n`;
            text += `${currentMatch.team2.name}: ${currentMatch.team2.sets}\n\n`;
            text += `Set actual: ${currentMatch.currentSet} de 5\n`;
            text += `Puntos para ganar: ${getTargetScore()} (con diferencia de 2)\n\n`;
            
            if (matchHistory.length > 0) {
                text += `=== 칔LTIMOS PARTIDOS ===\n`;
                const recentMatches = matchHistory.slice(0, 3);
                recentMatches.forEach((match, index) => {
                    const matchDate = new Date(match.timestamp).toLocaleDateString();
                    text += `${index + 1}. ${match.team1.name} ${match.team1.sets}-${match.team2.sets} ${match.team2.name} (${matchDate})\n`;
                });
            }
            
            text += `\n游님 Generado con Marcador de Voleibol`;
            
            return text;
        }

        function openShareModal() {
            shareTextEl.textContent = generateShareText();
            shareModal.style.display = 'flex';
        }

        function closeShareModal() {
            shareModal.style.display = 'none';
        }

        function copyShareText() {
            const text = generateShareText();
            navigator.clipboard.writeText(text).then(() => {
                alert("Texto copiado al portapapeles. Puedes pegarlo en cualquier aplicaci칩n.");
            }).catch(err => {
                console.error('Error al copiar texto: ', err);
                alert("No se pudo copiar el texto. Intenta manualmente.");
            });
        }

        function shareViaNative() {
            const text = generateShareText();
            
            if (navigator.share) {
                navigator.share({
                    title: 'Resultado de Voleibol',
                    text: text,
                    url: window.location.href
                }).then(() => {
                    console.log('Contenido compartido exitosamente');
                }).catch((error) => {
                    console.log('Error al compartir:', error);
                });
            } else {
                // Fallback para navegadores que no soportan la Web Share API
                copyShareText();
            }
        }

        function shareToWhatsapp() {
            const text = generateShareText();
            const encodedText = encodeURIComponent(text);
            const whatsappUrl = `https://wa.me/?text=${encodedText}`;
            
            // Intentar abrir WhatsApp Web o la app
            window.open(whatsappUrl, '_blank');
        }

        // ========== FUNCIONES CORREGIDAS PARA COOKIES ==========
        
        // Funci칩n para guardar en cookies (versi칩n corregida y simplificada)
        function saveToCookies() {
            try {
                const data = {
                    currentMatch: currentMatch,
                    matchHistory: matchHistory
                };
                
                const jsonData = JSON.stringify(data);
                const expirationDays = 7; // Los datos se guardan por 7 d칤as
                const date = new Date();
                date.setTime(date.getTime() + (expirationDays * 24 * 60 * 60 * 1000));
                const expires = "expires=" + date.toUTCString();
                
                document.cookie = `volleyballScoreboard=${encodeURIComponent(jsonData)}; ${expires}; path=/; SameSite=Lax`;
                console.log("Datos guardados en cookies correctamente");
            } catch (error) {
                console.error("Error al guardar en cookies:", error);
            }
        }

        // Funci칩n para cargar desde cookies (versi칩n corregida y simplificada)
        function loadFromCookies() {
            try {
                const cookieName = "volleyballScoreboard=";
                const cookies = document.cookie.split(';');
                
                for (let i = 0; i < cookies.length; i++) {
                    let cookie = cookies[i].trim();
                    if (cookie.indexOf(cookieName) === 0) {
                        const cookieValue = decodeURIComponent(cookie.substring(cookieName.length, cookie.length));
                        const data = JSON.parse(cookieValue);
                        
                        // Restaurar el partido actual
                        if (data.currentMatch) {
                            currentMatch = data.currentMatch;
                            // Asegurarse de que startTime sea una fecha v치lida
                            if (currentMatch.startTime) {
                                currentMatch.startTime = new Date(currentMatch.startTime);
                            } else {
                                currentMatch.startTime = new Date();
                            }
                        }
                        
                        // Restaurar el historial
                        if (data.matchHistory) {
                            matchHistory = data.matchHistory;
                        }
                        
                        console.log("Datos cargados desde cookies correctamente");
                        return;
                    }
                }
                console.log("No se encontraron cookies, usando valores por defecto");
            } catch (error) {
                console.error("Error al cargar desde cookies:", error);
                // En caso de error, usar valores por defecto
                currentMatch = {
                    team1: { name: "Equipo Local", score: 0, sets: 0 },
                    team2: { name: "Equipo Visitante", score: 0, sets: 0 },
                    currentSet: 1,
                    maxSets: 5,
                    startTime: new Date(),
                    setHistory: []
                };
                matchHistory = [];
            }
        }

        // ======================================================
    </script>
</body>
</html>
