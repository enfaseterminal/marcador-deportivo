<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Marcador de Voleibol</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary-color: #3498db;
            --secondary-color: #e74c3c;
            --dark-color: #2c3e50;
            --light-color: #ecf0f1;
            --success-color: #2ecc71;
            --warning-color: #f39c12;
            --shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            --transition: all 0.3s ease;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background: linear-gradient(135deg, #1a2a6c, #b21f1f, #fdbb2d);
            color: var(--light-color);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Cabecera reorganizada */
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding: 20px;
            background-color: rgba(44, 62, 80, 0.9);
            border-radius: 15px;
            box-shadow: var(--shadow);
            flex-wrap: wrap;
        }

        .header-left {
            flex: 1;
            min-width: 200px;
        }

        h1 {
            font-size: 2.2rem;
            margin-bottom: 5px;
            color: white;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }

        .subtitle {
            font-size: 1rem;
            opacity: 0.9;
        }

        .clock-container {
            background-color: rgba(52, 152, 219, 0.8);
            padding: 12px 20px;
            border-radius: 10px;
            text-align: center;
            box-shadow: var(--shadow);
            min-width: 150px;
        }

        #clock {
            font-size: 1.4rem;
            font-weight: bold;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3);
        }

        .scoreboard {
            display: flex;
            justify-content: space-between;
            margin-bottom: 30px;
            gap: 20px;
        }

        .team {
            flex: 1;
            background-color: rgba(44, 62, 80, 0.9);
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            box-shadow: var(--shadow);
            transition: var(--transition);
            position: relative;
        }

        .team:hover {
            transform: translateY(-5px);
        }

        .team-name {
            font-size: 1.5rem;
            margin-bottom: 15px;
            font-weight: bold;
            cursor: pointer;
            padding: 5px;
            border-radius: 5px;
            transition: var(--transition);
        }

        .team-name:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }

        .score {
            font-size: 4rem;
            font-weight: bold;
            margin: 20px 0;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }

        .score-controls {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 20px;
        }

        .btn {
            padding: 10px 15px;
            border: none;
            border-radius: 8px;
            font-size: 1.1rem;
            font-weight: bold;
            cursor: pointer;
            transition: var(--transition);
            box-shadow: var(--shadow);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-primary {
            background-color: var(--primary-color);
            color: white;
        }

        .btn-secondary {
            background-color: var(--secondary-color);
            color: white;
        }

        .btn-success {
            background-color: var(--success-color);
            color: white;
        }

        .btn-warning {
            background-color: var(--warning-color);
            color: white;
        }

        .btn-info {
            background-color: #17a2b8;
            color: white;
        }

        .btn:hover {
            transform: scale(1.05);
            opacity: 0.9;
        }

        .sets {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 20px;
        }

        .set {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background-color: rgba(255, 255, 255, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }

        .set.won {
            background-color: var(--success-color);
        }

        .match-controls {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 15px;
            margin: 30px 0;
        }

        .current-set {
            text-align: center;
            margin-bottom: 10px;
            font-size: 1.2rem;
            background-color: rgba(255, 255, 255, 0.1);
            padding: 10px;
            border-radius: 8px;
        }

        .history {
            background-color: rgba(44, 62, 80, 0.9);
            border-radius: 15px;
            padding: 20px;
            box-shadow: var(--shadow);
            margin-bottom: 20px;
        }

        .history h2 {
            text-align: center;
            margin-bottom: 20px;
            font-size: 1.8rem;
        }

        .history-list {
            max-height: 300px;
            overflow-y: auto;
            margin-bottom: 20px;
        }

        .history-item {
            background-color: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
        }

        .history-teams {
            flex: 1;
            min-width: 200px;
        }

        .history-score {
            font-weight: bold;
            font-size: 1.2rem;
            margin: 0 15px;
        }

        .history-info {
            font-size: 0.9rem;
            opacity: 0.8;
            width: 100%;
            margin-top: 5px;
        }

        .history-location {
            color: var(--primary-color);
            font-style: italic;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .modal-content {
            background-color: var(--dark-color);
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 500px;
            box-shadow: var(--shadow);
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal h2 {
            margin-bottom: 20px;
            text-align: center;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
        }

        .form-group input, .form-group textarea {
            width: 100%;
            padding: 12px;
            border-radius: 8px;
            border: none;
            background-color: rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 1rem;
        }

        .form-group textarea {
            min-height: 120px;
            resize: vertical;
        }

        .modal-buttons {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 20px;
        }

        .empty-history {
            text-align: center;
            padding: 20px;
            opacity: 0.7;
        }

        .export-controls {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 20px;
        }

        .share-preview {
            background-color: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
            text-align: center;
        }

        .share-preview h3 {
            margin-bottom: 15px;
        }

        #share-text {
            background-color: rgba(0, 0, 0, 0.2);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            text-align: left;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 200px;
            overflow-y: auto;
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background-color: var(--success-color);
            color: white;
            padding: 15px 20px;
            border-radius: 8px;
            box-shadow: var(--shadow);
            z-index: 1001;
            display: none;
            align-items: center;
            gap: 10px;
            max-width: 300px;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes slideOut {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(100%);
                opacity: 0;
            }
        }

        .notification.warning {
            background-color: var(--warning-color);
        }

        .notification.error {
            background-color: var(--secondary-color);
        }

        @media (max-width: 768px) {
            header {
                flex-direction: column;
                text-align: center;
                gap: 15px;
            }
            
            .header-left {
                width: 100%;
            }
            
            .scoreboard {
                flex-direction: column;
            }
            
            .score {
                font-size: 3rem;
            }
            
            h1 {
                font-size: 1.8rem;
            }
            
            .btn {
                padding: 8px 12px;
                font-size: 1rem;
            }
            
            .match-controls {
                gap: 10px;
            }
        }

        @media (max-width: 480px) {
            .container {
                padding: 10px;
            }
            
            .match-controls, .export-controls {
                flex-direction: column;
            }
            
            .btn {
                width: 100%;
            }
            
            .history-item {
                flex-direction: column;
                text-align: center;
            }
            
            .history-score {
                margin: 10px 0;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="header-left">
                <h1><i class="fas fa-volleyball-ball"></i> Marcador de Voleibol</h1>
                <p class="subtitle">Lleva el control de tus partidos de voleibol</p>
            </div>
            <div class="clock-container">
                <div id="clock">00:00:00</div>
                <div id="date">--/--/----</div>
            </div>
        </header>

        <div class="current-set">
            <strong>Set Actual:</strong> <span id="current-set">1</span> de <span id="max-sets">3</span> | 
            <strong>Puntos para ganar:</strong> <span id="target-score">25</span> (con diferencia de 2)
        </div>

        <div class="scoreboard">
            <div class="team" id="team1">
                <div class="team-name" id="team1-name">Equipo Local</div>
                <div class="score" id="team1-score">0</div>
                <div class="sets" id="team1-sets">
                    <!-- Los sets se generar谩n din谩micamente -->
                </div>
                <div class="score-controls">
                    <button class="btn btn-primary" id="team1-add">
                        <i class="fas fa-plus"></i> Punto
                    </button>
                    <button class="btn btn-secondary" id="team1-remove">
                        <i class="fas fa-minus"></i> Punto
                    </button>
                </div>
            </div>

            <div class="team" id="team2">
                <div class="team-name" id="team2-name">Equipo Visitante</div>
                <div class="score" id="team2-score">0</div>
                <div class="sets" id="team2-sets">
                    <!-- Los sets se generar谩n din谩micamente -->
                </div>
                <div class="score-controls">
                    <button class="btn btn-primary" id="team2-add">
                        <i class="fas fa-plus"></i> Punto
                    </button>
                    <button class="btn btn-secondary" id="team2-remove">
                        <i class="fas fa-minus"></i> Punto
                    </button>
                </div>
            </div>
        </div>

        <div class="match-controls">
            <button class="btn btn-success" id="new-set">
                <i class="fas fa-flag"></i> Nuevo Set
            </button>
            <button class="btn btn-warning" id="reset-match">
                <i class="fas fa-redo"></i> Reiniciar Partido
            </button>
            <button class="btn btn-primary" id="save-match">
                <i class="fas fa-save"></i> Guardar Partido
            </button>
        </div>

        <div class="export-controls">
            <button class="btn btn-info" id="export-json">
                <i class="fas fa-file-code"></i> Exportar a JSON
            </button>
            <button class="btn btn-info" id="export-csv">
                <i class="fas fa-file-csv"></i> Exportar a CSV
            </button>
            <button class="btn btn-success" id="share-whatsapp">
                <i class="fab fa-whatsapp"></i> Compartir por WhatsApp
            </button>
            <button class="btn btn-primary" id="share-results">
                <i class="fas fa-share-alt"></i> Compartir Resultados
            </button>
        </div>

        <div class="history">
            <h2><i class="fas fa-history"></i> Historial de Partidos</h2>
            <div class="history-list" id="history-list">
                <!-- Los partidos guardados se mostrar谩n aqu铆 -->
            </div>
            <div class="match-controls">
                <button class="btn btn-secondary" id="clear-history">
                    <i class="fas fa-trash"></i> Borrar Historial
                </button>
            </div>
        </div>
    </div>

    <!-- Modal para editar nombres de equipos -->
    <div class="modal" id="team-name-modal">
        <div class="modal-content">
            <h2>Editar Nombre del Equipo</h2>
            <div class="form-group">
                <label for="team-name-input">Nombre del equipo:</label>
                <input type="text" id="team-name-input" placeholder="Ingresa el nombre del equipo">
            </div>
            <div class="modal-buttons">
                <button class="btn btn-secondary" id="cancel-edit">Cancelar</button>
                <button class="btn btn-primary" id="save-name">Guardar</button>
            </div>
        </div>
    </div>

    <!-- Modal para guardar partido con ubicaci贸n -->
    <div class="modal" id="save-match-modal">
        <div class="modal-content">
            <h2>Guardar Partido</h2>
            <div class="form-group">
                <label>Resultado:</label>
                <div style="background-color: rgba(255,255,255,0.1); padding: 10px; border-radius: 8px; margin-bottom: 15px;">
                    <p id="save-match-result"></p>
                </div>
            </div>
            <div class="form-group">
                <label for="match-location">Ubicaci贸n (opcional):</label>
                <input type="text" id="match-location" placeholder="Ej: Polideportivo Municipal, Sala de Entrenamiento...">
            </div>
            <div class="modal-buttons">
                <button class="btn btn-secondary" id="cancel-save">Cancelar</button>
                <button class="btn btn-primary" id="confirm-save">Guardar Partido</button>
            </div>
        </div>
    </div>

    <!-- Modal para compartir resultados -->
    <div class="modal" id="share-modal">
        <div class="modal-content">
            <h2>Compartir Resultados</h2>
            <div class="share-preview">
                <h3>Vista previa del resultado:</h3>
                <div id="share-text">
                    <!-- Texto generado din谩micamente -->
                </div>
                <div class="modal-buttons">
                    <button class="btn btn-secondary" id="copy-text">
                        <i class="fas fa-copy"></i> Copiar Texto
                    </button>
                    <button class="btn btn-success" id="share-native">
                        <i class="fas fa-share"></i> Compartir
                    </button>
                    <button class="btn btn-secondary" id="close-share">Cerrar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Notificaci贸n -->
    <div class="notification" id="notification">
        <i class="fas fa-check-circle"></i>
        <span id="notification-text">Operaci贸n realizada con 茅xito</span>
    </div>

    <script>
        // Variables globales
        let currentMatch = {
            team1: {
                name: "Equipo Local",
                score: 0,
                sets: 0
            },
            team2: {
                name: "Equipo Visitante",
                score: 0,
                sets: 0
            },
            currentSet: 1,
            maxSets: 3, // Cambiado a 3 sets para mini voleibol
            startTime: new Date(),
            // Para almacenar los puntos de cada set
            setHistory: [],
            winner: null
        };

        let matchHistory = [];
        let editingTeam = null;
        let savingMatchAfterWin = false;

        // Elementos DOM
        const team1NameEl = document.getElementById('team1-name');
        const team1ScoreEl = document.getElementById('team1-score');
        const team1SetsEl = document.getElementById('team1-sets');
        const team1AddBtn = document.getElementById('team1-add');
        const team1RemoveBtn = document.getElementById('team1-remove');

        const team2NameEl = document.getElementById('team2-name');
        const team2ScoreEl = document.getElementById('team2-score');
        const team2SetsEl = document.getElementById('team2-sets');
        const team2AddBtn = document.getElementById('team2-add');
        const team2RemoveBtn = document.getElementById('team2-remove');

        const newSetBtn = document.getElementById('new-set');
        const resetMatchBtn = document.getElementById('reset-match');
        const saveMatchBtn = document.getElementById('save-match');
        const clearHistoryBtn = document.getElementById('clear-history');
        const exportJsonBtn = document.getElementById('export-json');
        const exportCsvBtn = document.getElementById('export-csv');
        const shareWhatsappBtn = document.getElementById('share-whatsapp');
        const shareResultsBtn = document.getElementById('share-results');

        const historyListEl = document.getElementById('history-list');
        const clockEl = document.getElementById('clock');
        const dateEl = document.getElementById('date');
        const currentSetEl = document.getElementById('current-set');
        const targetScoreEl = document.getElementById('target-score');
        const maxSetsEl = document.getElementById('max-sets');

        const teamNameModal = document.getElementById('team-name-modal');
        const teamNameInput = document.getElementById('team-name-input');
        const cancelEditBtn = document.getElementById('cancel-edit');
        const saveNameBtn = document.getElementById('save-name');

        const saveMatchModal = document.getElementById('save-match-modal');
        const saveMatchResultEl = document.getElementById('save-match-result');
        const matchLocationInput = document.getElementById('match-location');
        const cancelSaveBtn = document.getElementById('cancel-save');
        const confirmSaveBtn = document.getElementById('confirm-save');

        const shareModal = document.getElementById('share-modal');
        const shareTextEl = document.getElementById('share-text');
        const copyTextBtn = document.getElementById('copy-text');
        const shareNativeBtn = document.getElementById('share-native');
        const closeShareBtn = document.getElementById('close-share');

        const notificationEl = document.getElementById('notification');
        const notificationTextEl = document.getElementById('notification-text');

        // Funci贸n para mostrar notificaciones
        function showNotification(message, type = 'success') {
            notificationTextEl.textContent = message;
            notificationEl.className = `notification ${type}`;
            notificationEl.style.display = 'flex';
            
            setTimeout(() => {
                notificationEl.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => {
                    notificationEl.style.display = 'none';
                    notificationEl.style.animation = '';
                }, 300);
            }, 3000);
        }

        // Funci贸n para obtener el puntaje objetivo seg煤n el set actual
        function getTargetScore() {
            // Todos los sets son a 25 puntos en mini voleibol
            return 25;
        }

        // Funci贸n para actualizar el reloj
        function updateClock() {
            const now = new Date();
            const timeString = now.toLocaleTimeString();
            const dateString = now.toLocaleDateString();
            
            clockEl.textContent = timeString;
            dateEl.textContent = dateString;
        }

        // Funci贸n para verificar si se ha ganado el set
        function checkSetWin() {
            const targetScore = getTargetScore();
            const score1 = currentMatch.team1.score;
            const score2 = currentMatch.team2.score;
            
            // Verificar si alg煤n equipo alcanz贸 el puntaje objetivo con diferencia de 2
            if (score1 >= targetScore && score1 - score2 >= 2) {
                // Equipo 1 gana el set
                currentMatch.team1.sets++;
                
                // Guardar resultado del set
                currentMatch.setHistory.push({
                    set: currentMatch.currentSet,
                    team1: score1,
                    team2: score2,
                    winner: currentMatch.team1.name
                });
                
                showNotification(`${currentMatch.team1.name} gana el set ${currentMatch.currentSet} (${score1}-${score2})`);
                checkMatchWin();
                return true;
            }
            
            if (score2 >= targetScore && score2 - score1 >= 2) {
                // Equipo 2 gana el set
                currentMatch.team2.sets++;
                
                // Guardar resultado del set
                currentMatch.setHistory.push({
                    set: currentMatch.currentSet,
                    team1: score1,
                    team2: score2,
                    winner: currentMatch.team2.name
                });
                
                showNotification(`${currentMatch.team2.name} gana el set ${currentMatch.currentSet} (${score1}-${score2})`);
                checkMatchWin();
                return true;
            }
            
            return false;
        }

        // Funci贸n para verificar si se ha ganado el partido
        function checkMatchWin() {
            const setsToWin = Math.ceil(currentMatch.maxSets / 2); // 2 de 3 sets
            
            if (currentMatch.team1.sets >= setsToWin || currentMatch.team2.sets >= setsToWin) {
                // Determinar ganador
                let winner;
                
                if (currentMatch.team1.sets > currentMatch.team2.sets) {
                    winner = currentMatch.team1.name;
                    currentMatch.winner = 'team1';
                } else {
                    winner = currentMatch.team2.name;
                    currentMatch.winner = 'team2';
                }
                
                // Mostrar mensaje de victoria con notificaci贸n
                showNotification(`隆${winner} ha ganado el partido! ${currentMatch.team1.sets}-${currentMatch.team2.sets}`, 'success');
                
                // Preparar para guardar el partido autom谩ticamente despu茅s de un breve retraso
                setTimeout(() => {
                    savingMatchAfterWin = true;
                    openSaveMatchModal();
                }, 1500);
                
                return true;
            } else {
                // Pasar al siguiente set despu茅s de un breve retraso
                setTimeout(() => {
                    startNewSet();
                }, 1500);
                return false;
            }
        }

        // Inicializaci贸n
        document.addEventListener('DOMContentLoaded', function() {
            // Iniciar reloj
            updateClock();
            setInterval(updateClock, 1000);
            
            // Cargar datos guardados
            loadFromCookies();
            renderCurrentMatch();
            renderMatchHistory();
            
            // Event listeners para los botones de puntuaci贸n
            team1AddBtn.addEventListener('click', () => updateScore('team1', 1));
            team1RemoveBtn.addEventListener('click', () => updateScore('team1', -1));
            team2AddBtn.addEventListener('click', () => updateScore('team2', 1));
            team2RemoveBtn.addEventListener('click', () => updateScore('team2', -1));
            
            // Event listeners para los nombres de equipos (edici贸n)
            team1NameEl.addEventListener('click', () => openTeamNameModal('team1'));
            team2NameEl.addEventListener('click', () => openTeamNameModal('team2'));
            
            // Event listeners para los controles del partido
            newSetBtn.addEventListener('click', () => {
                if (currentMatch.team1.score === 0 && currentMatch.team2.score === 0) {
                    showNotification("No hay puntos en el set actual. Agrega puntos antes de comenzar un nuevo set.", "warning");
                } else {
                    openSaveMatchModal();
                }
            });
            
            resetMatchBtn.addEventListener('click', resetCurrentMatch);
            saveMatchBtn.addEventListener('click', () => {
                if (currentMatch.setHistory.length === 0) {
                    showNotification("No hay sets completados para guardar.", "warning");
                } else {
                    openSaveMatchModal();
                }
            });
            
            clearHistoryBtn.addEventListener('click', clearMatchHistory);
            
            // Event listeners para exportaci贸n y compartir
            exportJsonBtn.addEventListener('click', exportToJson);
            exportCsvBtn.addEventListener('click', exportToCsv);
            shareWhatsappBtn.addEventListener('click', shareToWhatsapp);
            shareResultsBtn.addEventListener('click', openShareModal);
            
            // Event listeners para el modal de edici贸n de nombres
            cancelEditBtn.addEventListener('click', closeTeamNameModal);
            saveNameBtn.addEventListener('click', saveTeamName);
            
            // Event listeners para el modal de guardar partido
            cancelSaveBtn.addEventListener('click', closeSaveMatchModal);
            confirmSaveBtn.addEventListener('click', saveCurrentMatch);
            
            // Event listeners para el modal de compartir
            copyTextBtn.addEventListener('click', copyShareText);
            shareNativeBtn.addEventListener('click', shareViaNative);
            closeShareBtn.addEventListener('click', closeShareModal);
        });

        // Funciones principales
        function updateScore(team, change) {
            // Aplicar el cambio
            currentMatch[team].score += change;
            
            // Asegurarse de que el marcador no sea negativo
            if (currentMatch[team].score < 0) {
                currentMatch[team].score = 0;
            }
            
            // Verificar si se gan贸 el set despu茅s de actualizar el puntaje
            const setWon = checkSetWin();
            
            // Si no se gan贸 el set, renderizar normalmente
            if (!setWon) {
                renderCurrentMatch();
                saveToCookies();
            }
        }

        function startNewSet() {
            // Solo avanzar al siguiente set si no hemos alcanzado el m谩ximo
            if (currentMatch.currentSet < currentMatch.maxSets) {
                currentMatch.currentSet++;
                currentMatch.team1.score = 0;
                currentMatch.team2.score = 0;
                renderCurrentMatch();
                saveToCookies();
                
                showNotification(`Comienza el set ${currentMatch.currentSet}`);
            }
        }

        function resetCurrentMatch() {
            // Verificar si hay datos que perder
            if (currentMatch.team1.score > 0 || currentMatch.team2.score > 0 || currentMatch.setHistory.length > 0) {
                if (confirm("驴Est谩s seguro de que quieres reiniciar el partido? Se perder谩 el progreso actual.")) {
                    performReset();
                }
            } else {
                performReset();
            }
        }

        function performReset() {
            currentMatch.team1.score = 0;
            currentMatch.team2.score = 0;
            currentMatch.team1.sets = 0;
            currentMatch.team2.sets = 0;
            currentMatch.currentSet = 1;
            currentMatch.startTime = new Date();
            currentMatch.setHistory = [];
            currentMatch.winner = null;
            renderCurrentMatch();
            saveToCookies();
            showNotification("Partido reiniciado correctamente");
        }

        function openSaveMatchModal() {
            // Mostrar el resultado en el modal
            saveMatchResultEl.textContent = `${currentMatch.team1.name} ${currentMatch.team1.sets} - ${currentMatch.team2.sets} ${currentMatch.team2.name}`;
            
            // Limpiar el campo de ubicaci贸n
            matchLocationInput.value = '';
            
            // Mostrar el modal
            saveMatchModal.style.display = 'flex';
        }

        function closeSaveMatchModal() {
            saveMatchModal.style.display = 'none';
            savingMatchAfterWin = false;
        }

        function saveCurrentMatch() {
            const location = matchLocationInput.value.trim();
            
            const now = new Date();
            const matchData = {
                team1: {...currentMatch.team1},
                team2: {...currentMatch.team2},
                currentSet: currentMatch.currentSet,
                setHistory: [...currentMatch.setHistory],
                winner: currentMatch.winner,
                location: location || "No especificada",
                date: now.toLocaleString(),
                timestamp: now.getTime(),
                duration: Math.round((now - currentMatch.startTime) / 1000 / 60) // Duraci贸n en minutos
            };
            
            matchHistory.unshift(matchData);
            
            // Mantener solo los 煤ltimos 20 partidos
            if (matchHistory.length > 20) {
                matchHistory = matchHistory.slice(0, 20);
            }
            
            renderMatchHistory();
            saveToCookies();
            
            // Cerrar el modal
            closeSaveMatchModal();
            
            // Mostrar notificaci贸n
            showNotification("Partido guardado correctamente en el historial");
            
            // Si se estaba guardando despu茅s de ganar, reiniciar el partido
            if (savingMatchAfterWin) {
                setTimeout(() => {
                    performReset();
                }, 500);
            }
        }

        function clearMatchHistory() {
            if (confirm("驴Est谩s seguro de que quieres borrar todo el historial de partidos?")) {
                matchHistory = [];
                renderMatchHistory();
                saveToCookies();
                showNotification("Historial de partidos borrado correctamente");
            }
        }

        function openTeamNameModal(team) {
            editingTeam = team;
            teamNameInput.value = currentMatch[team].name;
            teamNameModal.style.display = 'flex';
        }

        function closeTeamNameModal() {
            teamNameModal.style.display = 'none';
            editingTeam = null;
        }

        function saveTeamName() {
            if (editingTeam && teamNameInput.value.trim() !== '') {
                currentMatch[editingTeam].name = teamNameInput.value.trim();
                renderCurrentMatch();
                saveToCookies();
                showNotification(`Nombre cambiado a: ${currentMatch[editingTeam].name}`);
            }
            closeTeamNameModal();
        }

        // Funciones de renderizado
        function renderCurrentMatch() {
            // Actualizar nombres
            team1NameEl.textContent = currentMatch.team1.name;
            team2NameEl.textContent = currentMatch.team2.name;
            
            // Actualizar puntuaciones
            team1ScoreEl.textContent = currentMatch.team1.score;
            team2ScoreEl.textContent = currentMatch.team2.score;
            
            // Actualizar sets
            renderSets(team1SetsEl, currentMatch.team1.sets);
            renderSets(team2SetsEl, currentMatch.team2.sets);
            
            // Actualizar informaci贸n del set actual
            currentSetEl.textContent = currentMatch.currentSet;
            maxSetsEl.textContent = currentMatch.maxSets;
            targetScoreEl.textContent = getTargetScore();
        }

        function renderSets(container, setsWon) {
            container.innerHTML = '';
            for (let i = 0; i < currentMatch.maxSets; i++) {
                const setEl = document.createElement('div');
                setEl.className = 'set';
                if (i < setsWon) {
                    setEl.classList.add('won');
                }
                setEl.textContent = i + 1;
                container.appendChild(setEl);
            }
        }

        function renderMatchHistory() {
            historyListEl.innerHTML = '';
            
            if (matchHistory.length === 0) {
                const emptyMessage = document.createElement('div');
                emptyMessage.className = 'empty-history';
                emptyMessage.innerHTML = '<i class="fas fa-clipboard-list fa-2x"></i><p>No hay partidos guardados. 隆Juega y guarda algunos partidos!</p>';
                historyListEl.appendChild(emptyMessage);
                return;
            }
            
            matchHistory.forEach((match, index) => {
                const historyItem = document.createElement('div');
                historyItem.className = 'history-item';
                
                const teamsDiv = document.createElement('div');
                teamsDiv.className = 'history-teams';
                teamsDiv.textContent = `${match.team1.name} vs ${match.team2.name}`;
                
                const scoreDiv = document.createElement('div');
                scoreDiv.className = 'history-score';
                scoreDiv.textContent = `${match.team1.sets}-${match.team2.sets}`;
                
                const infoDiv = document.createElement('div');
                infoDiv.className = 'history-info';
                infoDiv.innerHTML = `
                    <div>${match.date}</div>
                    <div class="history-location"><i class="fas fa-map-marker-alt"></i> ${match.location}</div>
                `;
                
                historyItem.appendChild(teamsDiv);
                historyItem.appendChild(scoreDiv);
                historyItem.appendChild(infoDiv);
                
                historyListEl.appendChild(historyItem);
            });
        }

        // Funciones de exportaci贸n
        function exportToJson() {
            if (matchHistory.length === 0) {
                showNotification("No hay datos para exportar. Guarda algunos partidos primero.", "warning");
                return;
            }
            
            const data = {
                currentMatch: currentMatch,
                matchHistory: matchHistory,
                exportDate: new Date().toISOString()
            };
            
            const jsonData = JSON.stringify(data, null, 2);
            const blob = new Blob([jsonData], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = `marcador_voleibol_${new Date().toISOString().slice(0, 10)}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showNotification("Datos exportados a JSON correctamente.");
        }

        function exportToCsv() {
            if (matchHistory.length === 0) {
                showNotification("No hay datos para exportar. Guarda algunos partidos primero.", "warning");
                return;
            }
            
            // Encabezados CSV
            let csv = "Fecha,Hora,Equipo 1,Puntos Equipo 1,Sets Equipo 1,Equipo 2,Puntos Equipo 2,Sets Equipo 2,Ganador,Ubicaci贸n,Duraci贸n (min),Detalle Sets\n";
            
            // Datos de cada partido
            matchHistory.forEach(match => {
                const date = new Date(match.timestamp);
                const fecha = date.toLocaleDateString();
                const hora = date.toLocaleTimeString();
                const ganador = match.winner === 'team1' ? match.team1.name : match.team2.name;
                const duracion = match.duration || 0;
                
                // Detalle de sets
                let detalleSets = "";
                if (match.setHistory && match.setHistory.length > 0) {
                    detalleSets = match.setHistory.map(s => `Set ${s.set}: ${s.team1}-${s.team2}`).join("; ");
                }
                
                csv += `"${fecha}","${hora}","${match.team1.name}",${match.team1.score},${match.team1.sets},"${match.team2.name}",${match.team2.score},${match.team2.sets},"${ganador}","${match.location}",${duracion},"${detalleSets}"\n`;
            });
            
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = `marcador_voleibol_${new Date().toISOString().slice(0, 10)}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showNotification("Datos exportados a CSV correctamente. Puedes abrir el archivo en Excel.");
        }

        // Funciones para compartir
        function generateShareText() {
            const now = new Date();
            const dateStr = now.toLocaleDateString();
            const timeStr = now.toLocaleTimeString();
            
            let text = ` MARCADOR DE VOLEIBOL \n`;
            text += ` ${dateStr}  ${timeStr}\n\n`;
            text += `=== PARTIDO ACTUAL ===\n`;
            text += `${currentMatch.team1.name}: ${currentMatch.team1.score} puntos\n`;
            text += `${currentMatch.team2.name}: ${currentMatch.team2.score} puntos\n\n`;
            text += `Sets ganados:\n`;
            text += `${currentMatch.team1.name}: ${currentMatch.team1.sets}\n`;
            text += `${currentMatch.team2.name}: ${currentMatch.team2.sets}\n\n`;
            text += `Set actual: ${currentMatch.currentSet} de ${currentMatch.maxSets}\n`;
            text += `Puntos para ganar: ${getTargetScore()} (con diferencia de 2)\n\n`;
            
            if (currentMatch.setHistory.length > 0) {
                text += `=== HISTORIAL DE SETS ===\n`;
                currentMatch.setHistory.forEach(set => {
                    text += `Set ${set.set}: ${set.team1}-${set.team2} (Ganador: ${set.winner})\n`;
                });
                text += `\n`;
            }
            
            if (matchHistory.length > 0) {
                text += `=== LTIMOS PARTIDOS ===\n`;
                const recentMatches = matchHistory.slice(0, 3);
                recentMatches.forEach((match, index) => {
                    const matchDate = new Date(match.timestamp).toLocaleDateString();
                    text += `${index + 1}. ${match.team1.name} ${match.team1.sets}-${match.team2.sets} ${match.team2.name}`;
                    if (match.location && match.location !== "No especificada") {
                        text += ` (${match.location})`;
                    }
                    text += `\n`;
                });
            }
            
            text += `\n Generado con Marcador de Voleibol`;
            
            return text;
        }

        function openShareModal() {
            shareTextEl.textContent = generateShareText();
            shareModal.style.display = 'flex';
        }

        function closeShareModal() {
            shareModal.style.display = 'none';
        }

        function copyShareText() {
            const text = generateShareText();
            navigator.clipboard.writeText(text).then(() => {
                showNotification("Texto copiado al portapapeles. Puedes pegarlo en cualquier aplicaci贸n.");
            }).catch(err => {
                console.error('Error al copiar texto: ', err);
                showNotification("No se pudo copiar el texto. Intenta manualmente.", "error");
            });
        }

        function shareViaNative() {
            const text = generateShareText();
            
            if (navigator.share) {
                navigator.share({
                    title: 'Resultado de Voleibol',
                    text: text,
                    url: window.location.href
                }).then(() => {
                    console.log('Contenido compartido exitosamente');
                }).catch((error) => {
                    console.log('Error al compartir:', error);
                });
            } else {
                // Fallback para navegadores que no soportan la Web Share API
                copyShareText();
            }
        }

        function shareToWhatsapp() {
            const text = generateShareText();
            const encodedText = encodeURIComponent(text);
            const whatsappUrl = `https://wa.me/?text=${encodedText}`;
            
            // Intentar abrir WhatsApp Web o la app
            window.open(whatsappUrl, '_blank');
        }

        // Funciones de almacenamiento con cookies
        function saveToCookies() {
            const data = {
                currentMatch: currentMatch,
                matchHistory: matchHistory
            };
            
            const jsonData = JSON.stringify(data);
            const expirationDays = 30;
            const date = new Date();
            date.setTime(date.getTime() + (expirationDays * 24 * 60 * 60 * 1000));
            const expires = "expires=" + date.toUTCString();
            
            document.cookie = `volleyballScoreboard=${encodeURIComponent(jsonData)}; ${expires}; path=/`;
        }

        function loadFromCookies() {
            const cookies = document.cookie.split(';');
            let volleyballScoreboardCookie = null;
            
            for (const cookie of cookies) {
                const [name, value] = cookie.trim().split('=');
                if (name === 'volleyballScoreboard') {
                    volleyballScoreboardCookie = value;
                    break;
                }
            }
            
            if (volleyballScoreboardCookie) {
                try {
                    const data = JSON.parse(decodeURIComponent(volleyballScoreboardCookie));
                    currentMatch = data.currentMatch || currentMatch;
                    matchHistory = data.matchHistory || matchHistory;
                } catch (e) {
                    console.error('Error al cargar datos de cookies:', e);
                }
            }
        }
    </script>
</body>
</html>
